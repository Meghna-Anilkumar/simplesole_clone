<%- include('./sidebar') %>
<style>
  body {
    font-family: Arial, sans-serif;
    margin: 20px;
  }
  form {
    max-width: 600px;
    margin: auto;
  }
  label {
    display: block;
    margin-top: 10px;
  }
  input,
  select {
    width: 100%;
    padding: 8px;
    margin-top: 5px;
    margin-bottom: 10px;
    box-sizing: border-box;
  }
  button {
    background-color: #4CAF50;
    color: white;
    padding: 10px 15px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
  }
  .preview-container {
    display: inline-block;
    margin: 5px;
    position: relative;
  }
  .delete-button {
    position: absolute;
    top: 0;
    right: 0;
    background-color: red;
    color: white;
    border: none;
    padding: 2px 6px;
    cursor: pointer;
    border-radius: 50%;
    width: 20px;
    height: 20px;
    line-height: 16px;
    text-align: center;
  }
  .error-message {
    color: red;
    font-size: 14px;
    margin-top: 5px;
  }
  .warning-message {
    color: orange;
    font-size: 14px;
    margin-top: 5px;
    font-weight: bold;
  }
  .image-section {
    border: 2px dashed #ccc;
    padding: 15px;
    margin: 10px 0;
    border-radius: 5px;
  }
  .modal-content {
    padding: 20px;
  }
  #cropper-container {
    max-width: 100%;
    max-height: 400px;
    margin-bottom: 10px;
  }
  #cropper-container img {
    max-width: 100%;
    max-height: 400px;
  }
  .cropper-buttons {
    display: flex;
    gap: 10px;
    margin-top: 10px;
  }
  #imageQueue {
    margin-top: 10px;
    font-size: 14px;
    color: #666;
  }
  .section-title {
    font-weight: bold;
    margin: 15px 0 10px 0;
    color: #333;
  }
  .images-grid {
    display: flex;
    flex-wrap: wrap;
    gap: 10px;
  }
  .variant-section {
    border: 2px dashed #ccc;
    padding: 15px;
    margin: 10px 0;
    border-radius: 5px;
  }
  .variant-row {
    display: flex;
    gap: 10px;
    margin-bottom: 10px;
    align-items: center;
  }
  .variant-row input {
    flex: 1;
  }
  .variant-row button {
    background-color: #ff4444;
  }
</style>

<body>
  <div class="content">
    <form id="editProductForm" action="/updateProduct/<%= product._id %>" method="post" class="form-horizontal" enctype="multipart/form-data">
      <h2 style="color: blue;">Edit Product (<%= product.name %>)</h2>

      <div class="form-group">
        <label class="col-md-4 control-label" for="product_name">NAME</label>
        <div class="col-md-8">
          <input id="product_name" name="name" placeholder="" class="form-control input-md" required="true" type="text"
            value="<%= product.name %>">
          <div id="nameError" class="error-message"></div>
        </div>
      </div>

      <div class="form-group">
        <label class="col-md-4 control-label" for="product_name_fr">DESCRIPTION</label>
        <div class="col-md-8">
          <input id="product_name_fr" name="description" placeholder="" class="form-control input-md" required=""
            type="text" value="<%= product.description %>">
          <div id="descriptionError" class="error-message"></div>
        </div>
      </div>

      <div class="form-group">
        <label class="col-md-4 control-label" for="product_categorie">CATEGORY</label>
        <div class="col-md-4">
          <select id="product_categorie" name="category" class="form-control" required>
            <% category.forEach(cat => { %>
              <option value="<%= cat._id %>" <% if (product.category.equals(cat._id)) { %>selected<% } %>>
                <%= cat.name %>
              </option>
            <% }); %>
          </select>
          <div id="categoryError" class="error-message"></div>
        </div>
      </div>

      <div class="form-group">
        <label class="col-md-4 control-label" for="price">PRICE</label>
        <div class="col-md-4">
          <input id="price" name="price" placeholder="" class="form-control input-md" required="true" type="number" min="0" step="0.01"
            value="<%= product.price %>">
          <div id="priceError" class="error-message"></div>
        </div>
      </div>

      <div class="form-group variant-section">
        <label class="col-md-4 control-label">VARIANTS (Size, Stock)</label>
        <div id="variantContainer">
          <% product.variants.forEach((variant, index) => { %>
            <div class="variant-row">
              <input type="text" name="variants[<%= index %>][size]" placeholder="Size" class="form-control input-md" required
                value="<%= variant.size %>">
              <input type="number" name="variants[<%= index %>][stock]" placeholder="Stock" class="form-control input-md" required min="0"
                value="<%= variant.stock %>">
              <button type="button" class="btn remove-variant">Remove</button>
            </div>
          <% }); %>
        </div>
        <button type="button" id="addVariant" class="btn btn-primary" style="margin-top: 10px;">Add Variant</button>
        <div id="variantError" class="error-message"></div>
      </div>

      <div class="form-group">
        <div class="image-section">
          <label class="col-md-4 control-label" for="filebutton">PRODUCT IMAGES</label>
          <div class="col-md-4">
            <input id="filebutton" name="images" class="input-file" type="file" multiple accept="image/*" onchange="openCropperModal(this)">
          </div>
          <div id="imageWarning" class="warning-message" style="display: none;">
            ⚠️ Products must have at least one image. Please upload new images or keep existing ones.
          </div>
          <div class="section-title">Current Images:</div>
          <div id="existingImages" class="images-grid">
            <% existingImages.forEach(image => { %>
              <div class="preview-container" data-image="<%= image %>">
                <img src="<%= image %>" style="width: 100px; height: 100px; object-fit: cover;">
                <button type="button" class="delete-button" onclick="removeExistingImage('<%= image %>')">×</button>
              </div>
            <% }); %>
          </div>
          <div class="section-title" id="newImagesTitle" style="display: none;">New Images:</div>
          <div id="newImagesPreview" class="images-grid">
          </div>
        </div>
      </div>

      <input type="hidden" name="deletedImages" id="deletedImages" value="">
      <input type="hidden" name="croppedImages" id="croppedImages" value="">

      <div class="form-group">
        <label class="col-md-4 control-label" for="singlebutton"></label>
        <div class="col-md-4">
          <button type="button" id="singlebutton" name="singlebutton" class="btn btn-primary">Update Product</button>
        </div>
      </div>
    </form>
  </div>

  <div class="modal fade" id="cropperModal" tabindex="-1" aria-labelledby="cropperModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="cropperModalLabel">Crop Image</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div id="cropper-container">
            <img id="imageToCrop" src="" alt="Image to crop">
          </div>
          <div id="imageQueue">Images remaining: <span id="queueCount">0</span></div>
          <div class="cropper-buttons">
            <button type="button" id="cropButton" class="btn btn-primary">Crop and Next</button>
            <button type="button" id="skipButton" class="btn btn-warning">Skip</button>
            <button type="button" id="finishButton" class="btn btn-success">Finish Cropping</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.6.1/cropper.min.css" rel="stylesheet">

  <script>
    const productData = {
      id: '<%= product._id %>',
      variantCount: <%= product.variants ? product.variants.length : 0 %>
    };
    console.log('productData:', productData);
    let deletedImages = [];
    let croppedImages = [];
    let cropper;
    let fileQueue = [];
    let currentFileIndex = 0;
    let modal;
    let variantCount = productData.variantCount;

    $(document).ready(function() {
      updateRemoveButtons();
      reindexVariants();
      checkImageCount();
    });

    $('#addVariant').on('click', function () {
      const variantContainer = $('#variantContainer');
      const variantRow = $('<div>', { class: 'variant-row' }).html(`
        <input type="text" name="variants[${variantCount}][size]" placeholder="Size" class="form-control input-md" required>
        <input type="number" name="variants[${variantCount}][stock]" placeholder="Stock" class="form-control input-md" required min="0">
        <button type="button" class="btn remove-variant">Remove</button>
      `);
      variantContainer.append(variantRow);
      variantCount++;
      updateRemoveButtons();
      reindexVariants();
    });

    function updateRemoveButtons() {
      $('.remove-variant').off('click').on('click', removeVariantHandler);
    }

    function removeVariantHandler() {
      const variantRows = $('.variant-row');
      if (variantRows.length > 1) {
        $(this).parent().remove();
        reindexVariants();
      } else {
        Swal.fire({
          icon: 'error',
          title: 'Cannot Remove',
          text: 'At least one variant is required.',
        });
      }
    }

    function reindexVariants() {
      $('.variant-row').each(function(index) {
        $(this).find('input').eq(0).attr('name', `variants[${index}][size]`);
        $(this).find('input').eq(1).attr('name', `variants[${index}][stock]`);
      });
      variantCount = $('.variant-row').length;
    }

    function openCropperModal(input) {
      console.log('Opening cropper modal, files selected:', input.files.length);
      fileQueue = Array.from(input.files);
      currentFileIndex = 0;
      if (fileQueue.length > 0) {
        modal = new bootstrap.Modal(document.getElementById('cropperModal'), {
          backdrop: 'static',
          keyboard: false
        });
        processNextImage();
      } else {
        Swal.fire({
          icon: 'error',
          title: 'No Images',
          text: 'Please select at least one image to upload.',
        });
      }
    }

    function processNextImage() {
      console.log('Processing image', currentFileIndex + 1, 'of', fileQueue.length);
      if (currentFileIndex >= fileQueue.length) {
        console.log('All images processed, closing modal');
        if (modal) modal.hide();
        clearFileInput();
        return;
      }
      const currentFile = fileQueue[currentFileIndex];
      const reader = new FileReader();
      reader.onload = function (e) {
        const imageToCrop = document.getElementById('imageToCrop');
        imageToCrop.src = e.target.result;
        document.getElementById('queueCount').textContent = `${fileQueue.length - currentFileIndex}`;
        if (!modal._isShown) modal.show();
        document.getElementById('cropperModal').addEventListener('shown.bs.modal', initializeCropper, { once: true });
        if (modal._isShown) initializeCropper();
      };
      reader.readAsDataURL(currentFile);
    }

    function initializeCropper() {
      console.log('Initializing cropper for current image');
      if (cropper) {
        cropper.destroy();
        cropper = null;
      }
      const imageToCrop = document.getElementById('imageToCrop');
      cropper = new Cropper(imageToCrop, {
        aspectRatio: 1,
        viewMode: 1,
        autoCropArea: 0.8,
        responsive: true,
        checkCrossOrigin: false,
      });
    }

    function clearFileInput() {
      $('#filebutton').val('');
      currentFileIndex = 0;
      fileQueue = [];
    }

    $('#cropButton').on('click', function () {
      console.log('Crop button clicked');
      if (!cropper) {
        console.error('Cropper not initialized');
        return;
      }
      const canvas = cropper.getCroppedCanvas({ width: 300, height: 300 });
      canvas.toBlob(function(blob) {
        const formData = new FormData();
        formData.append('croppedImage', blob, `cropped_${Date.now()}_${fileQueue[currentFileIndex].name}`);
        
        console.log('Uploading cropped image to /upload-cropped-image');
        $.ajax({
          url: '/upload-cropped-image',
          type: 'POST',
          data: formData,
          processData: false,
          contentType: false,
          success: function(result) {
            console.log('Upload response:', result);
            if (result.filename) {
              croppedImages.push(result.filename);
              $('#croppedImages').val(JSON.stringify(croppedImages));
              console.log('Total cropped images:', croppedImages.length);
              addNewImagePreview(result.filename);
              currentFileIndex++;
              if (cropper) {
                cropper.destroy();
                cropper = null;
              }
              processNextImage();
            } else {
              throw new Error(result.error || 'No filename returned');
            }
          },
          error: function(xhr, status, error) {
            console.error('Error uploading cropped image:', error);
            const data = xhr.responseJSON;
            Swal.fire({
              icon: 'error',
              title: 'Upload Failed',
              text: data?.message || error || 'Failed to upload cropped image',
            });
          }
        });
      }, 'image/jpeg', 0.8);
    });

    $('#skipButton').on('click', function () {
      console.log('Skip button clicked');
      if (cropper) {
        cropper.destroy();
        cropper = null;
      }
      currentFileIndex++;
      processNextImage();
    });

    $('#finishButton').on('click', function () {
      console.log('Finish button clicked');
      if (cropper) {
        cropper.destroy();
        cropper = null;
      }
      if (modal) modal.hide();
      clearFileInput();
    });

    $('#cropperModal').on('hidden.bs.modal', function () {
      console.log('Modal hidden');
      if (cropper) {
        cropper.destroy();
        cropper = null;
      }
      clearFileInput();
    });

    function addNewImagePreview(imageUrl) {
      const newImagesPreview = $('#newImagesPreview');
      const newImagesTitle = $('#newImagesTitle');
      newImagesTitle.show();
      
      const previewDiv = $('<div>', { 
        class: 'preview-container',
        'data-new-image': imageUrl 
      });
      
      const img = $('<img>', {
        src: imageUrl,
        css: {
          width: '100px',
          height: '100px',
          objectFit: 'cover'
        },
        alt: 'New product image preview'
      });
      
      const deleteButton = $('<button>', {
        class: 'delete-button',
        type: 'button',
        html: '×',
        click: function() {
          removeNewImage(imageUrl, previewDiv);
        }
      });
      
      previewDiv.append(img).append(deleteButton);
      newImagesPreview.append(previewDiv);
      checkImageCount();
    }

    function removeExistingImage(imageName) {
      Swal.fire({
        title: 'Remove Image?',
        text: 'Are you sure you want to remove this existing image?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, remove it!'
      }).then((result) => {
        if (result.isConfirmed) {
          deletedImages.push(imageName);
          $('#deletedImages').val(deletedImages.join(','));
          $(`#existingImages .preview-container[data-image="${imageName}"]`).remove();
          checkImageCount();
          
          Swal.fire({
            icon: 'success',
            title: 'Removed',
            text: 'Image marked for removal',
            timer: 1500,
            showConfirmButton: false
          });
        }
      });
    }

    function removeNewImage(imageUrl, previewDiv) {
      Swal.fire({
        title: 'Remove Image?',
        text: 'Are you sure you want to remove this new image?',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, remove it!'
      }).then((result) => {
        if (result.isConfirmed) {
          croppedImages = croppedImages.filter(url => url !== imageUrl);
          $('#croppedImages').val(JSON.stringify(croppedImages));
          previewDiv.remove();
          
          if (croppedImages.length === 0) {
            $('#newImagesTitle').hide();
          }
          checkImageCount();
          
          Swal.fire({
            icon: 'success',
            title: 'Removed',
            text: 'Image removed successfully',
            timer: 1500,
            showConfirmButton: false
          });
        }
      });
    }

    function checkImageCount() {
      const existingImagesCount = $('#existingImages').children().length;
      const newImagesCount = croppedImages.length;
      const totalImages = existingImagesCount + newImagesCount;
      const warningDiv = $('#imageWarning');
      const submitButton = $('#singlebutton');
      
      if (totalImages === 0) {
        warningDiv.show();
        submitButton.prop('disabled', true).css('backgroundColor', '#ccc');
      } else {
        warningDiv.hide();
        submitButton.prop('disabled', false).css('backgroundColor', '#007bff');
      }
    }

    $('#singlebutton').on('click', function (event) {
      event.preventDefault();
      console.log('Form submission started');
      clearErrorMessages();
      let hasErrors = false;
      
      if (!validateName()) hasErrors = true;
      if (!validateDescription()) hasErrors = true;
      if (!validateCategory()) hasErrors = true;
      if (!validatePrice()) hasErrors = true;
      if (!validateVariants()) hasErrors = true;
      if (!validateImages()) hasErrors = true;
      
      if (hasErrors) {
        console.log('Form validation failed');
        return;
      }
      
      if (!productData.id) {
        console.error('Product ID is undefined');
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Product ID is missing. Please reload the page and try again.',
        });
        return;
      }
      
      // Confirmation dialog before updating
      Swal.fire({
        title: 'Update Product?',
        text: 'Are you sure you want to update this product?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, update it!'
      }).then((result) => {
        if (result.isConfirmed) {
          console.log('Form validation passed, submitting to /updateProduct/' + productData.id);
          
          Swal.fire({
            title: 'Updating Product...',
            text: 'Please wait while we update your product.',
            allowOutsideClick: false,
            didOpen: () => {
              Swal.showLoading();
            }
          });
          
          const formData = $('#editProductForm').serialize();
          
          $.ajax({
            url: '/updateProduct/' + productData.id,
            type: 'POST',
            data: formData,
            success: function(response, status, xhr) {
              console.log('Update success response:', response);
              const contentType = xhr.getResponseHeader('content-type');
              
              Swal.close();
              
              if (contentType && contentType.includes('application/json')) {
                Swal.fire({
                  icon: 'error',
                  title: 'Error',
                  text: response.message || 'Failed to update product',
                });
              } else {
                Swal.fire({
                  icon: 'success',
                  title: 'Success',
                  text: 'Product updated successfully',
                  timer: 1500,
                  showConfirmButton: false
                }).then(() => {
                  window.location.href = '/products';
                });
              }
            },
            error: function(xhr, status, error) {
              console.error('Form submission error:', error);
              Swal.close();
              
              const contentType = xhr.getResponseHeader('content-type');
              let errorMessage = 'Failed to update product';
              
              if (xhr.status === 401) {
                errorMessage = 'Please log in to update the product.';
              } else if (contentType && contentType.includes('application/json')) {
                const data = xhr.responseJSON;
                errorMessage = data?.message || errorMessage;
              } else if (xhr.responseText) {
                errorMessage = 'Server returned ' + xhr.status + ': ' + xhr.responseText.substring(0, 100) + '...';
              }
              
              Swal.fire({
                icon: 'error',
                title: 'Error',
                text: errorMessage,
              });
            }
          });
        }
      });
    });

    function clearErrorMessages() {
      $('.error-message').text('');
    }

    function showError(elementId, message) {
      $('#' + elementId).text(message);
    }

    function validateName() {
      const name = $('#product_name').val().trim();
      if (!name) {
        showError('nameError', 'Product name is required');
        return false;
      }
      if (name.length < 2) {
        showError('nameError', 'Product name must be at least 2 characters');
        return false;
      }
      return true;
    }

    function validateDescription() {
      const description = $('#product_name_fr').val().trim();
      if (!description) {
        showError('descriptionError', 'Description is required');
        return false;
      }
      return true;
    }

    function validateCategory() {
      const category = $('#product_categorie').val();
      if (!category) {
        showError('categoryError', 'Please select a category');
        return false;
      }
      return true;
    }

    function validatePrice() {
      const price = $('#price').val();
      const numericPrice = parseFloat(price);
      if (!price || isNaN(numericPrice) || numericPrice <= 0) {
        showError('priceError', 'Please enter a valid price greater than 0');
        return false;
      }
      return true;
    }

    function validateVariants() {
      const variantRows = $('.variant-row');
      console.log('Number of variant rows:', variantRows.length);
      
      if (variantRows.length === 0) {
        showError('variantError', 'At least one variant is required');
        return false;
      }
      
      let valid = true;
      variantRows.each(function(index) {
        const row = $(this);
        const sizeInput = row.find(`input[name="variants[${index}][size]"]`);
        const stockInput = row.find(`input[name="variants[${index}][stock]"]`);
        
        if (sizeInput.length === 0 || stockInput.length === 0) {
          showError('variantError', 'Missing input for variant ' + (index + 1));
          valid = false;
          return;
        }
        
        const size = sizeInput.val().trim();
        const stock = stockInput.val();
        
        if (!size) {
          showError('variantError', 'Size is required for variant ' + (index + 1));
          valid = false;
        }
        if (!stock || isNaN(stock) || parseInt(stock) < 0) {
          showError('variantError', 'Valid stock quantity is required for variant ' + (index + 1));
          valid = false;
        }
      });
      
      return valid;
    }

    function validateImages() {
      const existingImagesCount = $('#existingImages').children().length;
      const newImagesCount = croppedImages.length;
      if (existingImagesCount + newImagesCount === 0) {
        showError('imageError', 'Please upload or keep at least one image');
        return false;
      }
      return true;
    }
  </script>
</body>
</html>