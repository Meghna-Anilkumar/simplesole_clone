<%- include('./sidebar') %>

<style>
  .coupon-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    margin-top: 20px;
    margin-left: 260px;
    padding-right: 20px;
  }

  .coupon-box {
    width: calc(33.33% - 20px);
    border: 1px solid #ccc;
    padding: 20px;
    margin-bottom: 20px;
    background-color: #ffffff;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s ease;
  }

  .coupon-box:hover {
    transform: translateY(-5px);
  }

  .coupon-box p {
    margin: 0 0 10px 0;
    font-size: 14px;
    color: #2c3e50;
  }

  .coupon-box button {
    margin-right: 10px;
  }

  .pagination-container {
    margin: 20px 260px 20px 260px;
    text-align: center;
  }

  .content {
    margin-left: 240px;
    padding: 20px;
    transition: margin-left 0.3s ease;
    min-height: 100vh;
    background-color: #f8f9fa;
  }

  @media (max-width: 992px) {
    .coupon-container {
      margin-left: 15px;
      padding-right: 15px;
    }

    .pagination-container {
      margin: 20px 15px;
    }

    .content {
      margin-left: 0;
      padding: 80px 15px 15px 15px;
    }

    .coupon-box {
      width: calc(50% - 15px);
    }
  }

  @media (max-width: 768px) {
    .coupon-box {
      width: 100%;
    }

    .coupon-container {
      margin-left: 10px;
      padding-right: 10px;
    }

    .pagination-container {
      margin: 20px 10px;
    }

    .content {
      padding: 80px 10px 10px 10px;
    }
  }

  @media (max-width: 576px) {
    .coupon-box {
      padding: 15px;
    }

    .coupon-box p {
      font-size: 13px;
    }

    .coupon-container {
      margin-left: 5px;
      padding-right: 5px;
    }

    .pagination-container {
      margin: 20px 5px;
    }

    .content {
      padding: 70px 5px 5px 5px;
    }
  }
</style>

<div class="content">
  <div class="container mt-3">
    <h2>Coupon Page</h2>
    <button class="btn btn-primary" id="openCouponModal" type="button" data-bs-toggle="modal" data-bs-target="#addCouponModal">
      <i class="fas fa-plus"></i> Add Coupon
    </button>
  </div>

  <!-- Coupon Details -->
  <% if (coupons.length > 0) { %>
    <div id="couponDetails" class="coupon-container">
      <% function formatDate(dateString) {
        const date = new Date(dateString);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
      } %>
      <% coupons.forEach(coupon => { %>
        <div class="coupon-box">
          <p><strong>Coupon Code:</strong> <%= coupon.couponCode %></p>
          <p><strong>Discount Rate:</strong> <%= coupon.discountRate %>%</p>
          <p><strong>Minimum Purchase Amount:</strong> <%= coupon.minimumPurchaseAmount %></p>
          <p><strong>Expiry Date:</strong> <%= formatDate(coupon.expiryDate) %></p>
          <button class="btn btn-primary edit-coupon-btn" 
                  data-bs-toggle="modal" 
                  data-bs-target="#editCouponModal"
                  data-coupon-id="<%= coupon._id %>"
                  data-coupon-code="<%= coupon.couponCode %>"
                  data-discount-rate="<%= coupon.discountRate %>"
                  data-min-purchase-amount="<%= coupon.minimumPurchaseAmount %>"
                  data-expiry-date="<%= coupon.expiryDate %>">Edit</button>
          <button class="btn btn-danger delete-coupon-btn" data-coupon-id="<%= coupon._id %>">Delete</button>
        </div>
      <% }) %>
    </div>

    <!-- Pagination Controls -->
    <% if (totalPages > 1) { %>
      <div class="pagination-container">
        <nav aria-label="Page navigation">
          <ul class="pagination justify-content-center">
            <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
              <a class="page-link" href="?page=<%= currentPage - 1 %>&limit=<%= limit %>">Previous</a>
            </li>
            <% for (let i = 1; i <= totalPages; i++) { %>
              <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                <a class="page-link" href="?page=<%= i %>&limit=<%= limit %>"><%= i %></a>
              </li>
            <% } %>
            <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
              <a class="page-link" href="?page=<%= currentPage + 1 %>&limit=<%= limit %>">Next</a>
            </li>
          </ul>
        </nav>
      </div>
    <% } %>
  <% } else { %>
    <div class="text-center" style="margin-top: 50px;">
      <h4>No coupons added yet.</h4>
      <p>Click the <strong>Add Coupon</strong> button above to create one.</p>
    </div>
  <% } %>
</div>

<!-- Add Coupon Modal -->
<div class="modal fade" id="addCouponModal" tabindex="-1" aria-labelledby="addCouponModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addCouponModalLabel">Add Coupon</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="couponCode" class="form-label">Coupon Code</label>
          <input type="text" class="form-control" id="couponCode" placeholder="Enter coupon code" required>
          <div id="couponCodeError" style="color: red;"></div>
        </div>
        <div class="mb-3">
          <label for="discountRate" class="form-label">Discount Rate (%)</label>
          <input type="number" class="form-control" id="discountRate" placeholder="Enter discount rate" required>
        </div>
        <div class="mb-3">
          <label for="minPurchaseAmount" class="form-label">Minimum Purchase Amount</label>
          <input type="number" class="form-control" id="minPurchaseAmount" placeholder="Enter minimum purchase amount" required>
        </div>
        <div class="mb-3">
          <label for="expiryDate" class="form-label">Expiry Date</label>
          <input type="date" class="form-control" id="expiryDate" required>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="submitCouponBtn">Submit</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Coupon Modal -->
<div class="modal fade" id="editCouponModal" tabindex="-1" aria-labelledby="editCouponModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editCouponModalLabel">Edit Coupon</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editCouponId">
        <div class="mb-3">
          <label for="editCouponCode" class="form-label">Coupon Code</label>
          <input type="text" class="form-control" id="editCouponCode" placeholder="Enter coupon code" required>
          <div id="editCouponCodeError" style="color: red;"></div>
        </div>
        <div class="mb-3">
          <label for="editDiscountRate" class="form-label">Discount Rate (%)</label>
          <input type="number" class="form-control" id="editDiscountRate" placeholder="Enter discount rate" required>
        </div>
        <div class="mb-3">
          <label for="editMinPurchaseAmount" class="form-label">Minimum Purchase Amount</label>
          <input type="number" class="form-control" id="editMinPurchaseAmount" placeholder="Enter minimum purchase amount" required>
        </div>
        <div class="mb-3">
          <label for="editExpiryDate" class="form-label">Expiry Date</label>
          <input type="date" class="form-control" id="editExpiryDate" required>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="updateCouponBtn">Update</button>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  $(document).ready(function () {
    // Add Coupon
    $('#submitCouponBtn').on('click', function () {
      const couponCode = $('#couponCode');
      const discountRate = $('#discountRate');
      const minPurchaseAmount = $('#minPurchaseAmount');
      const expiryDate = $('#expiryDate');
      const couponCodeError = $('#couponCodeError');

      // Validate inputs
      const couponCodeValue = couponCode.val().trim();
      if (couponCodeValue === "") {
        couponCodeError.text('Coupon code cannot be empty.');
        return;
      } else if (couponCodeValue.indexOf(' ') !== -1) {
        couponCodeError.text('Coupon code cannot contain spaces.');
        return;
      } else {
        couponCodeError.text('');
      }

      const discountRateValue = parseFloat(discountRate.val());
      if (isNaN(discountRateValue) || discountRateValue < 1 || discountRateValue > 100) {
        Swal.fire({
          icon: 'error',
          title: 'Invalid Discount Rate',
          text: 'Discount rate should be between 1 and 100'
        });
        return;
      }

      const minPurchaseAmountValue = parseFloat(minPurchaseAmount.val());
      if (isNaN(minPurchaseAmountValue) || minPurchaseAmountValue < 0) {
        Swal.fire({
          icon: 'error',
          title: 'Invalid Minimum Purchase Amount',
          text: 'Minimum purchase amount must be a non-negative number'
        });
        return;
      }

      const expiryDateValue = new Date(expiryDate.val());
      const currentDate = new Date();
      currentDate.setHours(0, 0, 0, 0);
      if (expiryDateValue < currentDate) {
        Swal.fire({
          icon: 'error',
          title: 'Invalid Expiry Date',
          text: 'Expiry date cannot be before the current date'
        });
        return;
      }

      // Confirmation dialog before adding
      Swal.fire({
        title: 'Add Coupon?',
        text: 'Are you sure you want to add this coupon?',
        icon: 'question',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, add it!'
      }).then((result) => {
        if (result.isConfirmed) {
          const formData = {
            couponCode: couponCodeValue,
            discountRate: discountRateValue,
            minPurchaseAmount: minPurchaseAmountValue,
            expiryDate: expiryDate.val()
          };

          $.ajax({
            url: '/submitcoupon',
            type: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(formData),
            success: function (data) {
              Swal.fire({
                icon: 'success',
                title: 'Success',
                text: 'Coupon added successfully'
              }).then(() => {
                $('#addCouponModal').modal('hide');
                location.reload();
              });
            },
            error: function (xhr) {
              const data = xhr.responseJSON;
              Swal.fire({
                icon: 'error',
                title: 'Error',
                text: data?.message || 'Failed to save coupon'
              });
            }
          });
        }
      });
    });

    // Edit Coupon - Populate Modal
    $('.edit-coupon-btn').on('click', function (e) {
      e.preventDefault();

      const couponId = $(this).data('coupon-id');
      const couponCode = $(this).data('coupon-code');
      const discountRate = $(this).data('discount-rate');
      const minPurchaseAmount = $(this).data('min-purchase-amount');
      const expiryDate = $(this).data('expiry-date');

      $('#editCouponId').val(couponId);
      $('#editCouponCode').val(couponCode);
      $('#editDiscountRate').val(discountRate);
      $('#editMinPurchaseAmount').val(minPurchaseAmount);
      $('#editExpiryDate').val(formatDateForInput(expiryDate));

      $('#editCouponModal').modal('show');
    });

    // Update Coupon
    $('#updateCouponBtn').on('click', function () {
      const editCouponId = $('#editCouponId').val();
      const editCouponCode = $('#editCouponCode');
      const editDiscountRate = $('#editDiscountRate');
      const editMinPurchaseAmount = $('#editMinPurchaseAmount');
      const editExpiryDate = $('#editExpiryDate');
      const editCouponCodeError = $('#editCouponCodeError');

      // Validate inputs
      const couponCodeValue = editCouponCode.val().trim();
      if (couponCodeValue === "") {
        editCouponCodeError.text('Coupon code cannot be empty.');
        return;
      } else if (couponCodeValue.indexOf(' ') !== -1) {
        editCouponCodeError.text('Coupon code cannot contain spaces.');
        return;
      } else {
        editCouponCodeError.text('');
      }

      const discountRateValue = parseFloat(editDiscountRate.val());
      if (isNaN(discountRateValue) || discountRateValue < 1 || discountRateValue > 100) {
        Swal.fire({
          icon: 'error',
          title: 'Invalid Discount Rate',
          text: 'Discount rate should be between 1 and 100'
        });
        return;
      }

      const minPurchaseAmountValue = parseFloat(editMinPurchaseAmount.val());
      if (isNaN(minPurchaseAmountValue) || minPurchaseAmountValue < 0) {
        Swal.fire({
          icon: 'error',
          title: 'Invalid Minimum Purchase Amount',
          text: 'Minimum purchase amount must be a non-negative number'
        });
        return;
      }

      const expiryDateValue = new Date(editExpiryDate.val());
      const currentDate = new Date();
      currentDate.setHours(0, 0, 0, 0);
      if (expiryDateValue < currentDate) {
        Swal.fire({
          icon: 'error',
          title: 'Invalid Expiry Date',
          text: 'Expiry date cannot be before the current date'
        });
        return;
      }

      const formData = {
        editCouponId,
        editCouponCode: couponCodeValue,
        editDiscountRate: discountRateValue,
        editMinPurchaseAmount: minPurchaseAmountValue,
        editExpiryDate: editExpiryDate.val()
      };

      $.ajax({
        url: '/updatecoupon',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function (data) {
          Swal.fire({
            icon: 'success',
            title: 'Success',
            text: 'Coupon updated successfully'
          }).then(() => {
            $('#editCouponModal').modal('hide');
            location.reload();
          });
        },
        error: function (xhr) {
          const data = xhr.responseJSON;
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: data?.message || 'Failed to update coupon'
          });
        }
      });
    });

    // Delete Coupon
    $('.delete-coupon-btn').on('click', function (e) {
      e.preventDefault();

      const couponId = $(this).data('coupon-id');
      const couponBox = $(this).closest('.coupon-box');

      Swal.fire({
        title: 'Are you sure?',
        text: 'You are about to delete this coupon. This action cannot be undone!',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#3085d6',
        cancelButtonColor: '#d33',
        confirmButtonText: 'Yes, delete it!'
      }).then((result) => {
        if (result.isConfirmed) {
          $.ajax({
            url: `/deletecoupon/${couponId}`,
            type: 'POST',
            success: function (data) {
              Swal.fire({
                icon: 'success',
                title: 'Deleted!',
                text: 'Coupon deleted successfully'
              }).then(() => {
                couponBox.remove();
              });
            },
            error: function (xhr) {
              const data = xhr.responseJSON;
              Swal.fire({
                icon: 'error',
                title: 'Error',
                text: data?.message || 'Failed to delete coupon'
              });
            }
          });
        }
      });
    });

    function formatDateForInput(dateString) {
      const date = new Date(dateString);
      if (isNaN(date.getTime())) return '';
      return date.toISOString().split('T')[0];
    }
  });
</script>