<%- include('./sidebar') %>

<div class="col-md-9 content">
  <!-- Heading -->
  <h2 style="color: crimson;">All Products</h2>

  <!-- Search Form -->
  <form method="get" action="/products" class="mb-4">
    <div class="input-group input-group-sm">
      <input type="text" name="search" 
             class="form-control form-control-sm" 
             style="max-width: 150px;" 
             placeholder="Search by name or category" 
             value="<%= typeof search !== 'undefined' ? search : '' %>">
      <button type="submit" class="btn btn-primary btn-sm">Search</button>
      <% if (typeof search !== 'undefined' && search !== '') { %>
        <a href="/products?page=1&limit=<%= limit %>" class="btn btn-secondary btn-sm ms-2">Reset</a>
      <% } %>
    </div>
  </form>

  <!-- Add Product Button -->
  <a href="/addProduct" class="btn btn-primary mb-3">Add Product</a>

  <% if(message) { %>
    <div class="alert alert-dismissable fade show alert-<%= message.type %>" role="alert">
      <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      <strong><%= message.message %></strong>
    </div>
  <% } %>

  <% if(product.length > 0) { %>
    <table class="table">
      <thead>
        <tr>
          <th>Index</th>
          <th>Image</th>
          <th>Name</th>
          <th>Category</th>
          <th>Price</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <% let startIndex = (currentPage - 1) * limit + 1; %>
        <% product.forEach((row, index) => { %>
          <tr class="align-middle" data-product-id="<%= row._id %>">
            <td><%= startIndex + index %></td>
            <td><img src="<%= row.images.length > 0 ? row.images[0] : '' %>" width="50" class="img-thumbnail"></td>
            <td><%= row.name %></td>
            <td><%= row.category.name %></td>
            <td><%= row.price %></td>
            <td>
              <a href="/editProduct/<%= row._id %>" class="text-success">
                <i class="fas fa-edit"></i>
              </a>
              <% if (row.blocked) { %>
                <button type="button" class="btn btn-success block-btn" data-product-id="<%= row._id %>" data-blocked="true" data-product-name="<%= row.name %>">Unblock</button>
              <% } else { %>
                <button type="button" class="btn btn-danger block-btn" data-product-id="<%= row._id %>" data-blocked="false" data-product-name="<%= row.name %>">Block</button>
              <% } %>
            </td>
          </tr>
        <% }) %>
      </tbody>
    </table>

    <!-- Pagination controls -->
    <nav aria-label="Page navigation">
      <ul class="pagination justify-content-center">
        <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
          <a class="page-link" href="/products?page=<%= currentPage - 1 %>&limit=<%= limit %>&search=<%= search || '' %>">&laquo;</a>
        </li>
        <% for (let i = 1; i <= totalPages; i++) { %>
          <li class="page-item <%= currentPage === i ? 'active' : '' %>">
            <a class="page-link" href="/products?page=<%= i %>&limit=<%= limit %>&search=<%= search || '' %>"><%= i %></a>
          </li>
        <% } %>
        <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
          <a class="page-link" href="/products?page=<%= currentPage + 1 %>&limit=<%= limit %>&search=<%= search || '' %>">&raquo;</a>
        </li>
      </ul>
    </nav>
  <% } else { %>
    <h1 class="text-center text-secondary mt-5">No products found</h1>
  <% } %>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  $(document).ready(function() {
    // Display error message if exists
    const errorMessage = "<%= message && message.type === 'danger' ? message.message : '' %>";
    if (errorMessage) {
      Swal.fire({
        icon: 'error',
        title: 'Oops...',
        text: errorMessage,
      });
    }

    // Handle block/unblock button clicks
    $('.block-btn').on('click', function() {
      const button = $(this);
      const productId = button.data('product-id');
      const isBlocked = button.data('blocked');
      const productName = button.data('product-name');
      const action = isBlocked ? 'unblock' : 'block';
      
      // Confirmation dialog
      Swal.fire({
        title: `${action.charAt(0).toUpperCase() + action.slice(1)} Product?`,
        text: `Are you sure you want to ${action} "${productName}"?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: isBlocked ? '#28a745' : '#d33',
        cancelButtonColor: '#6c757d',
        confirmButtonText: `Yes, ${action} it!`
      }).then((result) => {
        if (result.isConfirmed) {
          // Show loading
          Swal.fire({
            title: `${action.charAt(0).toUpperCase() + action.slice(1)}ing Product...`,
            text: 'Please wait',
            allowOutsideClick: false,
            didOpen: () => {
              Swal.showLoading();
            }
          });

          // AJAX request to block/unblock
          $.ajax({
            url: '/blockProduct',
            type: 'POST',
            data: {
              productId: productId
            },
            success: function(response) {
              Swal.close();
              
              // Update button state
              if (isBlocked) {
                button.removeClass('btn-success').addClass('btn-danger');
                button.text('Block');
                button.data('blocked', false);
              } else {
                button.removeClass('btn-danger').addClass('btn-success');
                button.text('Unblock');
                button.data('blocked', true);
              }
              
              // Success message
              Swal.fire({
                icon: 'success',
                title: 'Success',
                text: `Product ${action}ed successfully`,
                timer: 1500,
                showConfirmButton: false
              });
            },
            error: function(xhr, status, error) {
              Swal.close();
              const data = xhr.responseJSON;
              
              Swal.fire({
                icon: 'error',
                title: 'Error',
                text: data?.message || `Failed to ${action} product`,
              });
            }
          });
        }
      });
    });
  });
</script>
</body>
</html>