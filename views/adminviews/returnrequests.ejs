<%- include('./sidebar') %>
<style>
    .content {
        padding: 20px;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
    }

    th, td {
        border: 1px solid #ddd;
        padding: 8px;
        text-align: left;
    }

    th {
        background-color: #f2f2f2;
    }

    .btn {
        background-color: #4caf50;
        color: white;
        border: none;
        padding: 8px 16px;
        text-align: center;
        text-decoration: none;
        font-size: 14px;
        border-radius: 5px;
        cursor: pointer;
        margin-right: 5px;
    }

    .accept-btn {
        background-color: #4caf50;
    }

    .reject-btn {
        background-color: #f44336;
    }

    .btn:hover {
        opacity: 0.8;
    }
</style>

<div class="content">
  <h2>Return Requests</h2>

  <% if (returnRequests.length > 0) { %>
    <table>
      <thead>
        <tr>
          <th>Order ID</th>
          <th>Return Reason</th>
          <th>Action</th>
        </tr>
      </thead>
      <tbody>
        <% returnRequests.forEach(returnRequest => { %>
          <tr>
            <td><%= returnRequest.orderId %></td>
            <td><%= returnRequest.returnReason %></td>
            <td>
              <button class="btn accept-btn" data-order-id="<%= returnRequest._id %>">Accept</button>
              <button class="btn reject-btn" data-order-id="<%= returnRequest._id %>">Reject</button>
            </td>
          </tr>
        <% }); %>
      </tbody>
    </table>
  <% } else { %>
    <div style="
      text-align: center;
      background-color: #fff5f7;
      border: 1px solid #f8bbd0;
      border-radius: 10px;
      padding: 40px 20px;
      color: #e91e63;
      font-size: 18px;
      font-weight: 600;
      box-shadow: 0 5px 15px rgba(233, 30, 99, 0.1);
    ">
      <i class="fas fa-box-open" style="font-size: 40px; margin-bottom: 15px;"></i><br>
      No return requests at the moment!
    </div>
  <% } %>
</div>


<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.accept-btn').forEach(function(button) {
            button.addEventListener('click', function() {
                var orderId = this.dataset.orderId;
                Swal.fire({
                    title: 'Accept Return Request?',
                    text: 'Are you sure you want to accept this return request?',
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#4caf50',
                    cancelButtonColor: '#d33',
                    confirmButtonText: 'Yes, accept it!',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        handleAccept(orderId);
                    }
                });
            });
        });

        document.querySelectorAll('.reject-btn').forEach(function(button) {
            button.addEventListener('click', function() {
                var orderId = this.dataset.orderId;
                Swal.fire({
                    title: 'Reject Return Request?',
                    text: 'Are you sure you want to reject this return request?',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#f44336',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'Yes, reject it!',
                    cancelButtonText: 'Cancel'
                }).then((result) => {
                    if (result.isConfirmed) {
                        handleReject(orderId);
                    }
                });
            });
        });

        function handleAccept(orderId) {
            fetch('/returnrequests/' + orderId + '/accept', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(function(response) {
                return response.json().then(data => ({ status: response.status, data }));
            })
            .then(function({ status, data }) {
                if (status !== 200) {
                    throw new Error(data.message || 'Error accepting return request');
                }
                Swal.fire({
                    title: 'Success!',
                    text: `Return request accepted successfully! Refunded â‚¹${data.refundAmount || 0}`,
                    icon: 'success',
                    timer: 2000,
                    showConfirmButton: false
                }).then(() => {
                    location.reload();
                });
            })
            .catch(function(error) {
                console.error('Error accepting return request:', error);
                Swal.fire({
                    title: 'Error',
                    text: error.message || 'Failed to accept return request. Please try again.',
                    icon: 'error',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#3085d6'
                });
            });
        }

        function handleReject(orderId) {
            fetch('/returnrequests/' + orderId + '/reject', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(function(response) {
                return response.json().then(data => ({ status: response.status, data }));
            })
            .then(function({ status, data }) {
                if (status !== 200) {
                    throw new Error(data.message || 'Error rejecting return request');
                }
                Swal.fire({
                    title: 'Success!',
                    text: 'Return request rejected successfully!',
                    icon: 'success',
                    timer: 1500,
                    showConfirmButton: false
                }).then(() => {
                    location.reload();
                });
            })
            .catch(function(error) {
                console.error('Error rejecting return request:', error);
                Swal.fire({
                    title: 'Error',
                    text: error.message || 'Failed to reject return request. Please try again.',
                    icon: 'error',
                    confirmButtonText: 'OK',
                    confirmButtonColor: '#3085d6'
                });
            });
        }
    });
</script>

</body>
</html>