<%- include('./sidebar') %>

<style>
  .content {
    margin-left: 240px; /* Matches sidebar width */
    padding: 20px;
    transition: margin-left 0.3s ease;
    min-height: 100vh;
    background-color: #f8f9fa;
  }

  .offer-container {
    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    margin-top: 20px;
    margin-left: 260px; /* Aligned with sidebar's 240px width + 20px padding */
    padding-right: 20px;
  }

  .offer-box {
    width: calc(33.33% - 20px);
    border: 1px solid #ccc;
    padding: 20px;
    margin-bottom: 20px;
    background-color: #ffffff;
    border-radius: 8px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    transition: transform 0.2s ease;
  }

  .offer-box:hover {
    transform: translateY(-5px);
  }

  .offer-box p {
    margin: 0 0 10px 0;
    font-size: 14px;
    color: #2c3e50;
  }

  .offer-box button {
    margin-right: 10px;
  }

  .no-offers-card {
    margin-left: 260px; /* Aligned with sidebar */
    margin-right: 20px;
    margin-top: 50px;
    max-width: 600px;
    text-align: center;
  }

  .pagination-container {
    margin: 20px 260px 20px 260px; /* Aligned with sidebar */
    text-align: center;
  }

  .pagination .page-link {
    color: #2c3e50;
    border: 1px solid #ddd;
    border-radius: 4px;
    transition: all 0.3s ease;
  }

  .pagination .page-link:hover {
    background-color: rgba(233, 30, 99, 0.1);
    border-color: #e91e63;
  }

  .pagination .page-item.active .page-link {
    background: linear-gradient(135deg, #e91e63 0%, #f06292 100%);
    border-color: #e91e63;
    color: #ffffff;
  }

  .pagination .page-item.disabled .page-link {
    color: #6c757d;
    cursor: not-allowed;
  }

  /* Responsive Design */
  @media (max-width: 992px) {
    .content {
      margin-left: 0;
      padding: 80px 15px 15px 15px;
    }

    .offer-container {
      margin-left: 15px;
      padding-right: 15px;
    }

    .no-offers-card {
      margin-left: 15px;
      margin-right: 15px;
    }

    .pagination-container {
      margin: 20px 15px;
    }

    .offer-box {
      width: calc(50% - 15px); /* Two columns on tablet */
    }
  }

  @media (max-width: 768px) {
    .offer-box {
      width: 100%; /* Single column on mobile */
    }

    .offer-container {
      margin-left: 10px;
      padding-right: 10px;
    }

    .no-offers-card {
      margin-left: 10px;
      margin-right: 10px;
    }

    .pagination-container {
      margin: 20px 10px;
    }

    .offer-box p {
      font-size: 13px;
    }
  }

  @media (max-width: 576px) {
    .content {
      padding: 70px 10px 10px 10px;
    }

    .offer-container {
      margin-left: 5px;
      padding-right: 5px;
    }

    .no-offers-card {
      margin-left: 5px;
      margin-right: 5px;
    }

    .pagination-container {
      margin: 20px 5px;
    }

    .offer-box {
      padding: 15px;
    }

    .offer-box p {
      font-size: 12px;
    }

    .offer-box button {
      font-size: 12px;
      padding: 6px 12px;
    }
  }
</style>

<div class="content">
  <div class="container mt-3">
    <h2>Category Offer Page</h2>
    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCategoryOfferModal">
      <i class="fas fa-plus"></i> Add Category Offer
    </button>
  </div>

  <!-- Category Offer Details -->
  <% if (categoryOffers.length > 0) { %>
    <div id="categoryOfferDetails" class="offer-container">
      <% function formatDate(dateString) {
        const date = new Date(dateString);
        const day = String(date.getDate()).padStart(2, '0');
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const year = date.getFullYear();
        return `${day}/${month}/${year}`;
      } %>
      <% categoryOffers.forEach(categoryOffer => { %>
        <div class="offer-box">
          <p><strong>Category:</strong> <%= categoryOffer.category.name %></p>
          <p><strong>Discount Percentage:</strong> <%= categoryOffer.discountPercentage %>%</p>
          <p><strong>Start Date:</strong> <%= formatDate(categoryOffer.startDate) %></p>
          <p><strong>Expiry Date:</strong> <%= formatDate(categoryOffer.expiryDate) %></p>
          <button class="btn btn-primary edit-category-offer-btn"
                  data-bs-toggle="modal"
                  data-bs-target="#editCategoryOfferModal"
                  data-offer-id="<%= categoryOffer._id %>"
                  data-category-id="<%= categoryOffer.category._id %>"
                  data-discount-percentage="<%= categoryOffer.discountPercentage %>"
                  data-start-date="<%= categoryOffer.startDate %>"
                  data-expiry-date="<%= categoryOffer.expiryDate %>">Edit</button>
          <button class="btn btn-danger delete-category-offer-btn" data-offer-id="<%= categoryOffer._id %>">Delete</button>
        </div>
      <% }) %>
    </div>

    <% if (totalPages > 1) { %>
      <!-- Pagination Controls -->
      <div class="pagination-container">
        <nav aria-label="Page navigation">
          <ul class="pagination justify-content-center">
            <li class="page-item <%= currentPage === 1 ? 'disabled' : '' %>">
              <a class="page-link" href="?page=<%= currentPage - 1 %>&limit=<%= limit %>">Previous</a>
            </li>
            <% for (let i = 1; i <= totalPages; i++) { %>
              <li class="page-item <%= currentPage === i ? 'active' : '' %>">
                <a class="page-link" href="?page=<%= i %>&limit=<%= limit %>"><%= i %></a>
              </li>
            <% } %>
            <li class="page-item <%= currentPage === totalPages ? 'disabled' : '' %>">
              <a class="page-link" href="?page=<%= currentPage + 1 %>&limit=<%= limit %>">Next</a>
            </li>
          </ul>
        </nav>
      </div>
    <% } %>
  <% } else { %>
    <div class="no-offers-card">
      <div class="card shadow-sm p-4" style="border-radius: 12px;">
        <h4 class="text-muted">No Category Offers Available</h4>
        <p class="mt-2">Click the <strong>Add Category Offer</strong> button above to create one.</p>
      </div>
    </div>
  <% } %>
</div>

<!-- Add Category Offer Modal -->
<div class="modal fade" id="addCategoryOfferModal" tabindex="-1" aria-labelledby="addCategoryOfferModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addCategoryOfferModalLabel">Add Category Offer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-3">
          <label for="categoryDropdown" class="form-label">Select Category</label>
          <select class="form-select" id="categoryDropdown" required>
            <option value="" selected disabled>Select a category</option>
            <% categories.forEach(category => { %>
              <option value="<%= category._id %>"><%= category.name %></option>
            <% }) %>
          </select>
        </div>
        <div class="mb-3">
          <label for="discountPercentage" class="form-label">Discount Percentage (%)</label>
          <input type="number" class="form-control" id="discountPercentage" placeholder="Enter discount percentage" min="1" max="100">
        </div>
        <div class="mb-3">
          <label for="startDate" class="form-label">Start Date</label>
          <input type="date" class="form-control" id="startDate">
        </div>
        <div class="mb-3">
          <label for="expiryDate" class="form-label">Expiry Date</label>
          <input type="date" class="form-control" id="expiryDate">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="submitCategoryOfferBtn">Submit</button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Category Offer Modal -->
<div class="modal fade" id="editCategoryOfferModal" tabindex="-1" aria-labelledby="editCategoryOfferModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="editCategoryOfferModalLabel">Edit Category Offer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="editCategoryOfferId">
        <div class="mb-3">
          <label for="editCategoryDropdown" class="form-label">Select Category</label>
          <select class="form-select" id="editCategoryDropdown">
            <option value="" disabled>Select a category</option>
            <% categories.forEach(category => { %>
              <option value="<%= category._id %>"><%= category.name %></option>
            <% }) %>
          </select>
        </div>
        <div class="mb-3">
          <label for="editDiscountPercentage" class="form-label">Discount Percentage (%)</label>
          <input type="number" class="form-control" id="editDiscountPercentage" placeholder="Enter discount percentage" min="1" max="100">
        </div>
        <div class="mb-3">
          <label for="editStartDate" class="form-label">Start Date</label>
          <input type="date" class="form-control" id="editStartDate">
        </div>
        <div class="mb-3">
          <label for="editExpiryDate" class="form-label">Expiry Date</label>
          <input type="date" class="form-control" id="editExpiryDate">
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        <button type="button" class="btn btn-primary" id="updateCategoryOfferBtn">Update</button>
      </div>
    </div>
  </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" id="confirmationModal" tabindex="-1" aria-labelledby="confirmationModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="confirmationModalLabel">Confirm Category Offer</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>Are you sure you want to <strong id="confirmAction"></strong> this category offer?</p>
        <div id="confirmationDetails">
          <p><strong>Category:</strong> <span id="confirmCategory"></span></p>
          <p><strong>Discount:</strong> <span id="confirmDiscount"></span>%</p>
          <p><strong>Start Date:</strong> <span id="confirmStartDate"></span></p>
          <p><strong>Expiry Date:</strong> <span id="confirmExpiryDate"></span></p>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button type="button" class="btn btn-success" id="confirmActionBtn">Confirm</button>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  let confirmationModal;
  let currentAction = null;
  let currentFormData = null;

  $(document).ready(function() {
    confirmationModal = new bootstrap.Modal(document.getElementById('confirmationModal'));

    // Format date for input fields
    const formatDateForInput = (dateString) => {
      const date = new Date(dateString);
      return isNaN(date.getTime()) ? '' : date.toISOString().split('T')[0];
    };

    // Format date for display
    const formatDateForDisplay = (dateString) => {
      const date = new Date(dateString);
      const day = String(date.getDate()).padStart(2, '0');
      const month = String(date.getMonth() + 1).padStart(2, '0');
      const year = date.getFullYear();
      return `${day}/${month}/${year}`;
    };

    // Get category name by ID
    const getCategoryName = (categoryId) => {
      const select = document.getElementById('categoryDropdown');
      const option = select.querySelector(`option[value="${categoryId}"]`);
      return option ? option.textContent : 'Unknown';
    };

    // Reset form fields
    const resetAddOfferForm = () => {
      $('#categoryDropdown').val('');
      $('#discountPercentage').val('');
      $('#startDate').val('');
      $('#expiryDate').val('');
    };

    const resetEditOfferForm = () => {
      $('#editCategoryOfferId').val('');
      $('#editCategoryDropdown').val('');
      $('#editDiscountPercentage').val('');
      $('#editStartDate').val('');
      $('#editExpiryDate').val('');
    };

    // Reset forms when modals are hidden
    $('#addCategoryOfferModal').on('hidden.bs.modal', resetAddOfferForm);
    $('#editCategoryOfferModal').on('hidden.bs.modal', resetEditOfferForm);

    // Populate edit modal
    $('#editCategoryOfferModal').on('show.bs.modal', function(event) {
      const button = $(event.relatedTarget);
      if (!button.hasClass('edit-category-offer-btn')) return;

      const offerId = button.data('offer-id');
      const categoryId = button.data('category-id');
      const discountPercentage = button.data('discount-percentage');
      const startDate = button.data('start-date');
      const expiryDate = button.data('expiry-date');

      $('#editCategoryOfferId').val(offerId);
      $('#editCategoryDropdown').val(categoryId);
      $('#editDiscountPercentage').val(discountPercentage);
      $('#editStartDate').val(formatDateForInput(startDate));
      $('#editExpiryDate').val(formatDateForInput(expiryDate));
    });

    // Validate form data
    const validateOfferData = (categoryId, discountPercentage, startDate, expiryDate) => {
      if (!categoryId) {
        Swal.fire({ icon: 'error', title: 'Missing Category', text: 'Please select a category' });
        return false;
      }

      if (isNaN(discountPercentage) || discountPercentage < 1 || discountPercentage > 100) {
        Swal.fire({ icon: 'error', title: 'Invalid Discount', text: 'Discount percentage must be between 1 and 100' });
        return false;
      }

      if (!startDate) {
        Swal.fire({ icon: 'error', title: 'Missing Start Date', text: 'Please select a start date' });
        return false;
      }

      if (!expiryDate) {
        Swal.fire({ icon: 'error', title: 'Missing Expiry Date', text: 'Please select an expiry date' });
        return false;
      }

      const today = new Date();
      today.setHours(0, 0, 0, 0);
      const selectedStartDate = new Date(startDate);
      const selectedExpiryDate = new Date(expiryDate);

      if (isNaN(selectedStartDate.getTime()) || isNaN(selectedExpiryDate.getTime())) {
        Swal.fire({ icon: 'error', title: 'Invalid Date', text: 'Invalid date format' });
        return false;
      }

      if (selectedStartDate < today) {
        Swal.fire({ icon: 'error', title: 'Invalid Start Date', text: 'Start date cannot be in the past' });
        return false;
      }

      if (selectedExpiryDate <= selectedStartDate) {
        Swal.fire({ icon: 'error', title: 'Invalid Expiry Date', text: 'Expiry date must be after start date' });
        return false;
      }

      return true;
    };

    // Show confirmation modal
    const showConfirmation = (action, formData) => {
      currentAction = action;
      currentFormData = formData;

      $('#confirmAction').text(action === 'add' ? 'add' : 'update');
      $('#confirmCategory').text(getCategoryName(formData.categoryId));
      $('#confirmDiscount').text(formData.discountPercentage);
      $('#confirmStartDate').text(formatDateForDisplay(formData.startDate));
      $('#confirmExpiryDate').text(formatDateForDisplay(formData.expiryDate));

      confirmationModal.show();
    };

    // Add Category Offer
    $('#submitCategoryOfferBtn').on('click', function() {
      const categoryId = $('#categoryDropdown').val();
      const discountPercentage = parseInt($('#discountPercentage').val());
      const startDate = $('#startDate').val();
      const expiryDate = $('#expiryDate').val();

      if (!validateOfferData(categoryId, discountPercentage, startDate, expiryDate)) {
        return;
      }

      const formData = { categoryId, discountPercentage, startDate, expiryDate };
      
      // Hide add modal and show confirmation
      bootstrap.Modal.getInstance(document.getElementById('addCategoryOfferModal')).hide();
      showConfirmation('add', formData);
    });

    // Update Category Offer
    $('#updateCategoryOfferBtn').on('click', function() {
      const offerId = $('#editCategoryOfferId').val();
      const categoryId = $('#editCategoryDropdown').val();
      const discountPercentage = parseInt($('#editDiscountPercentage').val());
      const startDate = $('#editStartDate').val();
      const expiryDate = $('#editExpiryDate').val();

      if (!validateOfferData(categoryId, discountPercentage, startDate, expiryDate)) {
        return;
      }

      const formData = { offerId, categoryId, discountPercentage, startDate, expiryDate };
      
      // Hide edit modal and show confirmation
      bootstrap.Modal.getInstance(document.getElementById('editCategoryOfferModal')).hide();
      showConfirmation('update', formData);
    });

    // Confirm action button
    $('#confirmActionBtn').on('click', function() {
      confirmationModal.hide();

      if (currentAction === 'add') {
        submitAddOffer();
      } else if (currentAction === 'update') {
        submitUpdateOffer();
      }
    });

    // Submit add offer
    const submitAddOffer = () => {
      Swal.fire({
        title: 'Adding Category Offer...',
        text: 'Please wait',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      $.ajax({
        url: '/save-category-offer',
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(currentFormData),
        success: function(data) {
          Swal.fire({
            icon: 'success',
            title: 'Success',
            text: 'Category offer added successfully',
            timer: 1500,
            showConfirmButton: false
          }).then(() => {
            window.location.reload();
          });
        },
        error: function(xhr) {
          let errorMsg = 'Failed to save category offer';
          try {
            const data = JSON.parse(xhr.responseText);
            if (data.message) errorMsg = data.message;
          } catch (e) {}
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: errorMsg
          });
        }
      });
    };

    // Submit update offer
    const submitUpdateOffer = () => {
      Swal.fire({
        title: 'Updating Category Offer...',
        text: 'Please wait',
        allowOutsideClick: false,
        didOpen: () => {
          Swal.showLoading();
        }
      });

      $.ajax({
        url: `/update-category-offer/${currentFormData.offerId}`,
        type: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(currentFormData),
        success: function(data) {
          Swal.fire({
            icon: 'success',
            title: 'Success',
            text: 'Category offer updated successfully',
            timer: 1500,
            showConfirmButton: false
          }).then(() => {
            window.location.reload();
          });
        },
        error: function(xhr) {
          let errorMsg = 'Failed to update category offer';
          try {
            const data = JSON.parse(xhr.responseText);
            if (data.message) errorMsg = data.message;
          } catch (e) {}
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: errorMsg
          });
        }
      });
    };

    // Delete Category Offer
    $('.delete-category-offer-btn').on('click', function() {
      const offerId = $(this).data('offer-id');
      const offerBox = $(this).closest('.offer-box');

      Swal.fire({
        title: 'Are you sure?',
        text: 'You will not be able to recover this category offer!',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Yes, delete it!',
        cancelButtonText: 'Cancel'
      }).then((result) => {
        if (result.isConfirmed) {
          Swal.fire({
            title: 'Deleting...',
            text: 'Please wait',
            allowOutsideClick: false,
            didOpen: () => {
              Swal.showLoading();
            }
          });

          $.ajax({
            url: `/delete-category-offer/${offerId}`,
            type: 'POST',
            success: function(data) {
              Swal.fire({
                icon: 'success',
                title: 'Deleted!',
                text: 'Category offer has been deleted successfully',
                timer: 1500,
                showConfirmButton: false
              }).then(() => {
                offerBox.remove();
                // Check if no offers remain
                const offerContainer = $('#categoryOfferDetails');
                if (offerContainer.find('.offer-box').length === 0) {
                  window.location.reload();
                }
              });
            },
            error: function(xhr) {
              let errorMsg = 'Failed to delete category offer';
              try {
                const data = JSON.parse(xhr.responseText);
                if (data.message) errorMsg = data.message;
              } catch (e) {}
              Swal.fire({
                icon: 'error',
                title: 'Error',
                text: errorMsg
              });
            }
          });
        }
      });
    });
  });
</script>