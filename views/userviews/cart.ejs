<%- include('./header') %>
<style>
  body { background: #f5f5f5; min-height: 100vh; font-family: 'Open Sans', sans-serif; font-size: 0.9rem; font-weight: 600; }
  .container { padding-top: 100px; padding-bottom: 2rem; }
  .card { margin: 2rem auto; max-width: 1000px; background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); overflow: hidden; }
  .cart { padding: 2rem; border-radius: 12px 0 0 12px; background: #fff; }
  .summary { background: #e8ecef; padding: 2rem; border-radius: 0 12px 12px 0; color: #333; }
  .title h4 { color: rgb(255, 63, 108); font-size: 1.5rem; font-weight: 700; }
  .main { padding: 1.5rem 0; align-items: center; border-bottom: 1px solid #eee; }
  .cart-item img { width: 120px; height: 120px; object-fit: cover; border-radius: 8px; }
  .quantity-button { 
    background: #f5f5f5; border: 1px solid #ddd; padding: 0.5rem 1rem;
    font-size: 0.9rem; border-radius: 4px; min-width: 40px; transition: all 0.2s;
  }
  .quantity-button:hover:not(:disabled) { 
    background: rgb(255, 63, 108); color: white; border-color: rgb(255, 63, 108); 
  }
  .quantity-button:disabled { 
    background: #e0e0e0; color: #999; cursor: not-allowed; opacity: 0.7; 
  }
  .quantity { font-weight: bold; min-width: 50px; text-align: center; padding: 0 0.5rem; }
  .max-stock-warning { 
    color: #f39c12; font-size: 0.9rem; font-weight: 700; margin-top: 8px; 
  }
  .reserved-for-you { color: #27ae60; font-size: 0.85rem; font-weight: 600; margin-top: 8px; }
  .low-stock { color: #e74c3c; font-size: 0.85rem; font-weight: 600; margin-top: 8px; }
  .offer-details { font-size: 0.85rem; color: #666; }
  .size-select { padding: 0.5rem; border-radius: 4px; border: 1px solid #ddd; font-size: 0.9rem; max-width: 120px; }
  .label { font-size: 0.9rem; font-weight: 600; color: #333; margin-bottom: 0.5rem; display: block; }
  .current-price { font-size: 1.2rem; font-weight: 700; color: #333; }
  .original-price { font-size: 0.9rem; color: #999; text-decoration: line-through; margin-left: 8px; }
  .unavailable-items { background: #f8d7da; border: 1px solid #f5c6cb; padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; color: #721c24; }
</style>

<div class="container">
  <div class="card">
    <div class="row">
      <div class="col-md-8 cart">
        <div class="title">
          <div class="row">
            <div class="col"><h4><b>Shopping Cart</b></h4></div>
            <div class="col align-self-center text-right text-muted">
              <%= cart?.items?.length || 0 %> items
            </div>
          </div>
        </div>

        <% if (unavailableItems && unavailableItems.length > 0) { %>
          <div class="unavailable-items">
            <strong>Warning: Some items need attention:</strong>
            <ul>
              <% unavailableItems.forEach(item => { %>
                <li><%= item.name %> (Size: <%= item.size %>) - <%= item.reason %></li>
              <% }) %>
            </ul>
          </div>
        <% } %>

        <% if (cart && cart.items.length > 0) { %>
          <% cart.items.forEach(item => { %>
            <% 
              const variant = item.product.variants.find(v => v.size === item.size);
              if (!variant) return;

              const userReserved = item.quantity;
              const othersReserved = Math.max(0, (variant.reserved || 0) - userReserved);
              const stockAfterOthers = variant.stock - othersReserved;
              const maxAllowed = stockAfterOthers + userReserved;
              const isAtMax = item.quantity >= maxAllowed;
            %>

            <div class="row main cart-item border-bottom pb-4 mb-4">
              <div class="col-2">
                <a href="/products/<%= item.product._id %>">
                  <img class="img-fluid rounded" src="<%= item.product.images[0] %>" alt="<%= item.product.name %>">
                </a>
              </div>

              <div class="col-3">
                <div class="fw-bold"><%= item.product.name %></div>
                <% if (item.product.categoryofferprice < item.product.price) { %>
                  <small class="text-success">Category offer applied</small>
                <% } %>
              </div>

              <div class="col-4">
                <!-- Size -->
                <div class="mb-3">
                  <label class="label">Size:</label>
                  <select class="size-select form-control form-control-sm" onchange="updateSize('<%= item.product._id %>', this.value)">
                    <% item.product.variants.forEach(v => { %>
                      <% 
  const availForOthers = v.stock - Math.max(0, (v.reserved || 0) - (v.size === item.size ? item.quantity : 0));
  const disabled = availForOthers <= 0 && v.size !== item.size;
%>
<option value="<%= v.size %>" <%= v.size === item.size ? 'selected' : '' %> <%= disabled ? 'disabled' : '' %>>
  <%= v.size %> <%= disabled ? '(Out of Stock)' : '' %>
</option>
                    <% }) %>
                  </select>
                </div>

                <!-- Quantity -->
                <div>
                  <label class="label">Quantity:</label>
                  <div class="d-flex align-items-center">
                    <button type="button" class="quantity-button me-3"
                      id="minus_<%= item.product._id %>"
                      onclick="updateQuantity('<%= item.product._id %>', -1)"
                      <%= item.quantity <= 1 ? 'disabled' : '' %>>−</button>

                    <span id="quantity_<%= item.product._id %>"
                          class="quantity fw-bold mx-3"
                          data-max="<%= maxAllowed %>">
                      <%= item.quantity %>
                    </span>

                    <button type="button" class="quantity-button ms-3"
                      id="plus_<%= item.product._id %>"
                      onclick="updateQuantity('<%= item.product._id %>', 1)"
                      <%= isAtMax ? 'disabled' : '' %>>+</button>
                  </div>

                  <!-- Stock Message (Always visible when at max) -->
                  <div id="stockMsg_<%= item.product._id %>" class="mt-2">
                    <% if (isAtMax) { %>
                      <div class="max-stock-warning">
                        Maximum stock reached! This is all we have.
                      </div>
                    <% } else if (stockAfterOthers <= 0 && item.quantity > 0) { %>
                      <div class="reserved-for-you">
                        Reserved just for you!
                      </div>
                    <% } else if (stockAfterOthers < 3 && stockAfterOthers > 0) { %>
                      <div class="low-stock">
                        Only <%= stockAfterOthers %> left — Hurry!
                      </div>
                    <% } %>
                  </div>
                </div>
              </div>

              <div class="col-3 text-end">
                <div id="price_<%= item.product._id %>" class="mb-2">
                  <div class="current-price fw-bold">
                    ₹<%= ((item.price || item.product.price) * item.quantity).toLocaleString('en-IN') %>
                  </div>
                  <% if ((item.price || item.product.price) < item.product.price) { %>
                    <del class="text-muted small">
                      ₹<%= (item.product.price * item.quantity).toLocaleString('en-IN') %>
                    </del>
                  <% } %>
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger mt-2"
                        onclick="confirmRemoveItem('<%= item.product._id %>')">
                  Remove
                </button>
              </div>
            </div>
          <% }) %>
        <% } else { %>
          <div class="empty-cart text-center py-5">
            <img src="/images/emptycart.png" alt="Empty Cart" style="max-width: 250px;">
            <h5 class="mt-3">Your cart is empty</h5>
            <a href="/home" class="btn btn-dark mt-3">Continue Shopping</a>
          </div>
        <% } %>
      </div>

      <% if (cart && cart.items.length > 0) { %>
        <div class="col-md-4 summary">
          <h5><b>Order Summary</b></h5>
          <hr>
          <div class="row mb-2">
            <div class="col">Subtotal</div>
            <div class="col text-end fw-bold" id="totalPrice">₹<%= data.total.toFixed(2) %></div>
          </div>
          <div class="row fw-bold fs-5" style="border-top: 1px solid #ddd; padding-top: 15px;">
            <div class="col">Total</div>
            <div class="col text-end">₹<%= data.total.toFixed(2) %></div>
          </div>
          <button class="btn btn-dark w-100 mt-4 py-3 fw-bold"
                  <%= !canProceedToCheckout ? 'disabled' : '' %>
                  onclick="proceedToCheckout()">
            PROCEED TO CHECKOUT
          </button>
        </div>
      <% } %>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
let isFetching = false;

function updateQuantity(productId, change) {
  if (isFetching) return;
  isFetching = true;

  const qtySpan = document.getElementById(`quantity_${productId}`);
  const minusBtn = document.getElementById(`minus_${productId}`);
  const plusBtn = document.getElementById(`plus_${productId}`);
  const stockMsg = document.getElementById(`stockMsg_${productId}`);
  const currentQty = parseInt(qtySpan.innerText);
  const maxAllowed = parseInt(qtySpan.dataset.max);

  // Block + instantly if at max
  if (change === 1 && currentQty >= maxAllowed) {
    isFetching = false;
    return; // No request, no error
  }

  if (change === -1 && currentQty <= 1) {
    isFetching = false;
    return;
  }

  fetch(`/updateQuantity/${productId}/${change}`, { method: 'POST' })
    .then(r => r.ok ? r.json() : r.json().then(err => { throw err }))
    .then(data => {
      qtySpan.innerText = data.quantity;

      // Update buttons
      minusBtn.disabled = data.quantity <= 1;
      plusBtn.disabled = data.quantity >= data.maxAvailable;

      // Update price
      document.getElementById(`price_${productId}`).innerHTML = `
        <div class="current-price fw-bold">₹${data.itemPrice.toLocaleString('en-IN')}</div>
      `;

      // Update total
      document.getElementById('totalPrice').innerText = `₹${data.total.toFixed(2)}`;
      document.querySelectorAll('.summary .row').forEach(row => {
        const el = row.querySelector('.col.text-end');
        if (el && row.innerText.includes('Total')) {
          el.innerText = `₹${data.total.toFixed(2)}`;
        }
      });

      // Show max message instantly if at limit
      if (data.quantity >= data.maxAvailable) {
        stockMsg.innerHTML = `<div class="max-stock-warning">Maximum stock reached! This is all we have.</div>`;
      }
    })
    .catch(err => {
      // Silently ignore — user already at max
      console.log("Max stock reached, blocked:", err.error);
    })
    .finally(() => isFetching = false);
}

function proceedToCheckout() {
  if (isFetching) return;
  isFetching = true;
  fetch('/validateStockBeforeCheckout', { method: 'POST' })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        window.location.href = '/proceedtocheckout';
      } else {
        Swal.fire('Cannot Proceed', 'Some items are no longer available', 'error')
          .then(() => location.reload());
      }
    })
    .finally(() => isFetching = false);
}

function confirmRemoveItem(productId) {
  Swal.fire({
    title: 'Remove Item?',
    text: "This will release your reservation",
    icon: 'warning',
    showCancelButton: true,
    confirmButtonColor: '#dc3545',
    confirmButtonText: 'Yes, remove'
  }).then(result => {
    if (result.isConfirmed) {
      fetch(`/removeItem/${productId}`, { method: 'POST' })
        .then(() => location.reload())
        .catch(() => Swal.fire('Error', 'Failed to remove', 'error'));
    }
  });
}

function updateSize(productId, newSize) {
  if (isFetching) return;
  isFetching = true;
  fetch(`/updateSize/${productId}/${newSize}`, { method: 'POST' })
    .then(r => r.ok ? r.json() : r.json().then(err => { throw err }))
    .then(() => location.reload())
    .catch(err => {
      Swal.fire('Not Available', err.error || 'This size is out of stock', 'error');
    })
    .finally(() => isFetching = false);
}
</script>

<%- include('./footer') %>