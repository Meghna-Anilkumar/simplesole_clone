<%- include('./header', { title: 'OTP Verification' }) %>
<body class="bg-light">
    <div class="container mt-5">
        <h1 class="display-4">OTP Verification</h1>
        <p class="lead">An OTP has been sent to <strong><%= email %></strong>. Please enter the 6-digit OTP below.</p>
        
        <form id="otpForm" action="/verify-otp" method="post">
            <% if (typeof error !== 'undefined') { %>
                <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    <%= error %>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            <% } %>
            <% if (typeof message !== 'undefined') { %>
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <%= message %>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            <% } %>

            <input type="hidden" name="email" value="<%= email %>">

            <div class="col mb-4">
                <label for="otp" class="form-label">Enter OTP:</label>
                <input type="text" class="form-control" id="otp" name="otp" 
                       placeholder="Enter 6-digit OTP" maxlength="6" pattern="[0-9]{6}" 
                       title="Please enter a 6-digit OTP" required>
                <div class="invalid-feedback">
                    Please enter a valid 6-digit OTP.
                </div>
            </div>
            
            <button type="submit" class="btn btn-primary" id="submitBtn">Verify OTP</button>
        </form>

        <div id="otpTimer" class="mt-3">
            Resend OTP in <span id="countdown">60</span> seconds
        </div>
        <div id="resendLink" class="mt-3 d-none">
            <a href="/resend-otp" class="btn btn-link">Resend OTP</a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let countdown = 60;
        const countdownElement = document.getElementById('countdown');
        const otpTimerElement = document.getElementById('otpTimer');
        const resendLinkElement = document.getElementById('resendLink');
        const otpInput = document.getElementById('otp');
        const form = document.getElementById('otpForm');
        const submitBtn = document.getElementById('submitBtn');

        function updateCountdown() {
            countdownElement.textContent = countdown;
            if (countdown === 0) {
                otpTimerElement.classList.add('d-none');
                resendLinkElement.classList.remove('d-none');
                clearInterval(timer);
            } else {
                countdown--;
            }
        }

        updateCountdown();
        const timer = setInterval(updateCountdown, 1000);

        otpInput.focus();

        otpInput.addEventListener('input', function(e) {
            this.value = this.value.replace(/[^0-9]/g, '').slice(0, 6);
            if (this.value.length === 6) {
                this.classList.remove('is-invalid');
                this.classList.add('is-valid');
            } else {
                this.classList.remove('is-valid');
                this.classList.add('is-invalid');
            }
        });

        // Handle form submission with AJAX
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            if (otpInput.value.length !== 6 || !/^[0-9]{6}$/.test(otpInput.value)) {
                otpInput.classList.add('is-invalid');
                return;
            }

            submitBtn.disabled = true;
            submitBtn.innerHTML = 'Verifying... <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';

            try {
                const response = await fetch('/verify-otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        email: '<%= email %>',
                        otp: otpInput.value
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    // Redirect based on flow (signup or reset password)
                    window.location.href = result.redirect || '/login';
                } else {
                    // Show error without reloading
                    form.insertAdjacentHTML('afterbegin', `
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            ${result.error || 'Invalid or expired OTP'}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    `);
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = 'Verify OTP';
                }
            } catch (error) {
                console.error('Error verifying OTP:', error);
                form.insertAdjacentHTML('afterbegin', `
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        Failed to verify OTP. Please try again.
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                `);
                submitBtn.disabled = false;
                submitBtn.innerHTML = 'Verify OTP';
            }
        });

        // Handle resend OTP click (unchanged)
        resendLinkElement.querySelector('a').addEventListener('click', async function(e) {
            e.preventDefault();
            resendLinkElement.innerHTML = 'Sending... <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
            try {
                const response = await fetch('/resend-otp', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: '<%= email %>' })
                });
                const result = await response.json();
                if (response.ok) {
                    countdown = 60;
                    otpTimerElement.classList.remove('d-none');
                    resendLinkElement.classList.add('d-none');
                    countdownElement.textContent = countdown;
                    clearInterval(timer);
                    const newTimer = setInterval(updateCountdown, 1000);
                    form.insertAdjacentHTML('afterbegin', `
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                            New OTP sent successfully!
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    `);
                } else {
                    form.insertAdjacentHTML('afterbegin', `
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                            ${result.error || 'Failed to resend OTP. Please try again.'}
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    `);
                    resendLinkElement.innerHTML = '<a href="/resend-otp" class="btn btn-link">Resend OTP</a>';
                }
            } catch (error) {
                console.error('Error resending OTP:', error);
                form.insertAdjacentHTML('afterbegin', `
                    <div class="alert alert-danger alert-dismissible fade show" role="alert">
                        Failed to resend OTP. Please try again.
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                `);
                resendLinkElement.innerHTML = '<a href="/resend-otp" class="btn btn-link">Resend OTP</a>';
            }
        });
    </script>
<%- include('./footer') %>