<%- include('./header', { title: 'Reset Password' }) %>
<style>
  body {
    padding-top: 150px;
  }
  .reset-password-box {
    max-width: 400px;
    margin: 0 auto;
    padding: 20px;
    border: 1px solid #ccc;
    border-radius: 5px;
  }
  .form-title {
    text-align: center;
    margin-bottom: 20px;
  }
  .center-button {
    display: flex;
    justify-content: center;
  }
  .reset-btn {
    background-color: black;
  }
  .error-message {
    color: red;
    font-size: 14px;
    margin-top: 5px;
  }
</style>

<div class="container">
  <div class="reset-password-box">
    <h2 class="form-title">Reset Password</h2>
    <% if (typeof error !== 'undefined') { %>
      <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <%= error %>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    <% } %>
    <% if (typeof message !== 'undefined') { %>
      <div class="alert alert-success alert-dismissible fade show" role="alert">
        <%= message %>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    <% } %>
    <form id="resetForm" action="/reset-password" method="post">
      <input type="hidden" name="email" value="<%= email %>">
      <div class="mb-3">
        <label for="newPassword" class="form-label">New Password</label>
        <input
          type="password"
          name="newPassword"
          class="form-control"
          id="newPassword"
          placeholder="Enter new password"
          required
        />
        <div id="passwordError" class="error-message"></div>
      </div>
      <div class="mb-3">
        <label for="confirmPassword" class="form-label">Confirm Password</label>
        <input
          type="password"
          name="confirmPassword"
          class="form-control"
          id="confirmPassword"
          placeholder="Confirm new password"
          required
        />
        <div id="passwordMatchError" class="error-message"></div>
      </div>
      <div class="mb-3 center-button">
        <button type="submit" class="btn btn-primary reset-btn" id="submitBtn">Reset</button>
      </div>
    </form>
  </div>
</div>

<%- include('./footer') %>

<script>
  const passwordInput = document.getElementById('newPassword');
  const confirmPasswordInput = document.getElementById('confirmPassword');
  const passwordError = document.getElementById('passwordError');
  const passwordMatchError = document.getElementById('passwordMatchError');
  const form = document.getElementById('resetForm');
  const submitBtn = document.getElementById('submitBtn');

  function validatePassword() {
    const password = passwordInput.value;
    const strongPasswordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;

    if (!strongPasswordRegex.test(password)) {
      passwordError.textContent =
        "Password must be at least 8 characters long and include one uppercase letter, one lowercase letter, one number, and one special character.";
      passwordInput.classList.add('is-invalid');
      passwordInput.classList.remove('is-valid');
      return false;
    } else {
      passwordError.textContent = "";
      passwordInput.classList.remove('is-invalid');
      passwordInput.classList.add('is-valid');
      return true;
    }
  }

  function validatePasswordMatch() {
    const newPassword = passwordInput.value;
    const confirmPassword = confirmPasswordInput.value;
    if (newPassword !== confirmPassword) {
      passwordMatchError.textContent = "Passwords do not match";
      confirmPasswordInput.classList.add('is-invalid');
      confirmPasswordInput.classList.remove('is-valid');
      return false;
    } else {
      passwordMatchError.textContent = "";
      confirmPasswordInput.classList.remove('is-invalid');
      confirmPasswordInput.classList.add('is-valid');
      return true;
    }
  }

  passwordInput.addEventListener('input', validatePassword);
  confirmPasswordInput.addEventListener('input', validatePasswordMatch);

  form.addEventListener('submit', function (event) {
    const isPasswordValid = validatePassword();
    const isPasswordMatch = validatePasswordMatch();
    if (!isPasswordValid || !isPasswordMatch) {
      event.preventDefault();
    } else {
      submitBtn.disabled = true;
      submitBtn.innerHTML =
        'Resetting... <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
    }
  });
</script>